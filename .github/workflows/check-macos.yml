name: checks MacOS

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  cargo-check-each-crate-macos:
    runs-on: macOS
    env:
      SKIP_WASM_BUILD: 1
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - name: Set rust version from env file
        run: |
          RUST_VERSION=$(cat .github/env | sed -E 's/.*ci-unified:([^-]+)-([^-]+).*/\2/')
          echo $RUST_VERSION
          echo "RUST_VERSION=${RUST_VERSION}" >> $GITHUB_ENV
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@1ccc07ccd54b6048295516a3eb89b192c35057dc # master from 12.09.2024
      - uses: actions-rust-lang/setup-rust-toolchain@1fbea72663f6d4c03efaab13560c8a24cfd2a7cc # v1.9.0
        with:
          cache: false
          toolchain: ${{ env.RUST_VERSION }}
          target: wasm32-unknown-unknown
          components: cargo, clippy, rust-docs, rust-src, rustfmt, rustc, rust-std
      - name: Install protobuf
        run: brew install protobuf
      - name: cargo info
        run: |
          echo "######## rustup show ########"
          rustup show
          echo "######## rustup +nightly show ########"
          rustup +nightly show
          echo "######## cargo --version ########"
          cargo --version
      - name: Run cargo check
        run: cargo check --workspace --locked
